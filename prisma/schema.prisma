generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model ArtistProfile {
  id                           String             @id @default(cuid())
  userId                       String             @unique
  artistName                   String
  totalTracks                  Int                @default(0)
  totalSpent                   Int                @default(0)
  createdAt                    DateTime           @default(now())
  updatedAt                    DateTime           @updatedAt
  pendingBalance               Int                @default(0)
  stripeAccountId              String?            @unique
  stripeConnectedAt            DateTime?
  totalEarnings                Int                @default(0)
  stripeCustomerId             String?
  subscriptionCanceledAt       DateTime?
  subscriptionCurrentPeriodEnd DateTime?
  subscriptionId               String?
  subscriptionStatus           String?
  subscriptionTier             String?
  completedOnboarding          Boolean            @default(false)
  hasSeenCreditGuide           Boolean            @default(false)
  hasSeenWelcome               Boolean            @default(false)
  peerFlagCount                Int                @default(0)
  peerGemCount                 Int                @default(0)
  peerReviewRating             Float              @default(0)
  reviewCredits                Int                @default(1)
  totalCreditsEarned           Int                @default(0)
  totalCreditsSpent            Int                @default(0)
  totalPeerReviews             Int                @default(0)
  reviewerExpertise            ReviewerExpertise?
  User                         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  Review                       Review[]
  ReviewQueue                  ReviewQueue[]
  Track                        Track[]
  Genre_ArtistGenres           Genre[]            @relation("ArtistGenres")
  Genre_ArtistReviewGenres     Genre[]            @relation("ArtistReviewGenres")
  ChartSubmission              ChartSubmission[]
}

model EmailVerificationToken {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model ExternalPurchase {
  id                      String                 @id @default(cuid())
  trackId                 String
  buyerEmail              String
  buyerName               String?
  amount                  Int
  stripePaymentIntentId   String                 @unique
  stripeCheckoutSessionId String?
  status                  ExternalPurchaseStatus @default(PENDING)
  platformFee             Int
  affiliateCommission     Int                    @default(0)
  artistAmount            Int
  affiliateCode           String?
  affiliateUserId         String?
  downloadUrl             String?
  downloadedAt            DateTime?
  downloadCount           Int                    @default(0)
  createdAt               DateTime               @default(now())
  completedAt             DateTime?
  User                    User?                  @relation(fields: [affiliateUserId], references: [id])
  Track                   Track                  @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@index([affiliateCode])
  @@index([affiliateUserId])
  @@index([buyerEmail])
  @@index([status])
  @@index([trackId])
}

model Genre {
  id                               String            @id @default(cuid())
  name                             String            @unique
  slug                             String            @unique
  ArtistProfile_ArtistGenres       ArtistProfile[]   @relation("ArtistGenres")
  ArtistProfile_ArtistReviewGenres ArtistProfile[]   @relation("ArtistReviewGenres")
  ReviewerProfile                  ReviewerProfile[] @relation("ReviewerGenres")
  Track                            Track[]           @relation("TrackGenres")
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model Payment {
  id              String        @id @default(cuid())
  trackId         String        @unique
  amount          Int
  stripeSessionId String        @unique
  stripePaymentId String?
  status          PaymentStatus @default(PENDING)
  createdAt       DateTime      @default(now())
  completedAt     DateTime?
  Track           Track         @relation(fields: [trackId], references: [id], onDelete: Cascade)
}

model Payout {
  id              String          @id @default(cuid())
  reviewerId      String
  amount          Int
  method          PayoutMethod
  status          PayoutStatus
  externalId      String?
  createdAt       DateTime        @default(now())
  processedAt     DateTime?
  ReviewerProfile ReviewerProfile @relation(fields: [reviewerId], references: [id])
}

model Purchase {
  id                                                             String           @id @default(cuid())
  trackId                                                        String
  reviewerId                                                     String
  amount                                                         Int
  createdAt                                                      DateTime         @default(now())
  referredByReviewerId                                           String?
  referralShareId                                                String?
  commissionPaid                                                 Int              @default(0)
  ReviewerProfile_Purchase_referredByReviewerIdToReviewerProfile ReviewerProfile? @relation("Purchase_referredByReviewerIdToReviewerProfile", fields: [referredByReviewerId], references: [id])
  ReviewerProfile_Purchase_reviewerIdToReviewerProfile           ReviewerProfile  @relation("Purchase_reviewerIdToReviewerProfile", fields: [reviewerId], references: [id], onDelete: Cascade)
  Track                                                          Track            @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@unique([trackId, reviewerId])
  @@index([referredByReviewerId])
  @@index([reviewerId])
  @@index([trackId])
}

model RateLimit {
  id        String   @id @default(cuid())
  count     Int      @default(0)
  resetAt   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resetAt])
}

model Review {
  id                      String               @id @default(cuid())
  trackId                 String
  reviewerId              String?
  status                  ReviewStatus         @default(ASSIGNED)
  listenDuration          Int                  @default(0)
  lastHeartbeat           DateTime?
  firstImpression         FirstImpression?
  productionScore         Int?
  vocalScore              Int?
  originalityScore        Int?
  wouldListenAgain        Boolean?
  perceivedGenre          String?
  similarArtists          String?
  bestPart                String?
  bestPartTimestamp       Int?
  weakestPart             String?
  weakestTimestamp        Int?
  additionalNotes         String?
  paidAmount              Int                  @default(0)
  artistRating            Int?
  wasFlagged              Boolean              @default(false)
  flagReason              String?
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt
  isGem                   Boolean              @default(false)
  addressedArtistNote     AddressedArtistNote?
  nextActions             String?
  timestamps              Json?
  wouldAddToPlaylist      Boolean?
  wouldFollow             Boolean?
  wouldShare              Boolean?
  shareId                 String?              @unique
  countsTowardAnalytics   Boolean              @default(true)
  countsTowardCompletion  Boolean              @default(true)
  reviewSchemaVersion     Int                  @default(1)
  isPeerReview            Boolean              @default(false)
  peerReviewerArtistId    String?
  abTestComment           String?
  abTestPreference        ABTestPreference?
  biggestWeaknessSpecific String?
  dynamics                DynamicsQuality?
  emotionalImpact         Json?
  energyCurve             EnergyCurve?
  expectedPlacement       ExpectedPlacement?
  highEndQuality          HighEndQuality?
  lostInterestAt          Int?
  lostInterestReason      String?
  lowEndClarity           LowEndClarity?
  memorableMoment         String?
  nextFocus               NextFocus?
  playlistAction          PlaylistAction?
  qualityLevel            QualityLevel?
  quickWin                String?
  repetitiveNote          String?
  reviewerExpertise       ReviewerExpertise?
  stereoWidth             StereoWidth?
  targetAudience          Json?
  tooRepetitive           Boolean?
  trackLength             TrackLength?
  vocalClarity            VocalClarity?
  biggestRisk             String?
  competitiveBenchmark    String?
  releaseReadinessScore   Int?
  releaseVerdict          ReleaseVerdict?
  strongestElement        String?
  topFixRank1             String?
  topFixRank1Impact       FixImpact?
  topFixRank1TimeMin      Int?
  topFixRank2             String?
  topFixRank2Impact       FixImpact?
  topFixRank2TimeMin      Int?
  topFixRank3             String?
  topFixRank3Impact       FixImpact?
  topFixRank3TimeMin      Int?
  ArtistProfile           ArtistProfile?       @relation(fields: [peerReviewerArtistId], references: [id])
  ReviewerProfile         ReviewerProfile?     @relation(fields: [reviewerId], references: [id], onDelete: Cascade)
  Track                   Track                @relation(fields: [trackId], references: [id], onDelete: Cascade)
  ReviewTimestamp         ReviewTimestamp[]

  @@unique([trackId, reviewerId])
  @@unique([trackId, peerReviewerArtistId])
  @@index([reviewerId, status])
  @@index([status])
  @@index([trackId])
}

model ReviewQueue {
  id               String           @id @default(cuid())
  trackId          String
  reviewerId       String?
  priority         Int              @default(0)
  assignedAt       DateTime         @default(now())
  expiresAt        DateTime
  artistReviewerId String?
  ArtistProfile    ArtistProfile?   @relation(fields: [artistReviewerId], references: [id], onDelete: Cascade)
  ReviewerProfile  ReviewerProfile? @relation(fields: [reviewerId], references: [id], onDelete: Cascade)
  Track            Track            @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@unique([trackId, reviewerId])
  @@unique([trackId, artistReviewerId])
  @@index([artistReviewerId])
  @@index([reviewerId, expiresAt])
}

model ReviewTimestamp {
  id        String   @id @default(cuid())
  reviewId  String
  seconds   Int
  note      String
  createdAt DateTime @default(now())
  Review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@index([reviewId, seconds])
}

model ReviewerProfile {
  id                                                      String        @id @default(cuid())
  userId                                                  String        @unique
  tier                                                    ReviewerTier  @default(NORMAL)
  totalReviews                                            Int           @default(0)
  averageRating                                           Float         @default(0)
  totalEarnings                                           Int           @default(0)
  pendingBalance                                          Int           @default(0)
  spotifyId                                               String?
  lastfmUsername                                          String?
  stripeAccountId                                         String?       @unique
  flagCount                                               Int           @default(0)
  isRestricted                                            Boolean       @default(false)
  completedOnboarding                                     Boolean       @default(false)
  reviewsToday                                            Int           @default(0)
  lastReviewDate                                          DateTime?
  createdAt                                               DateTime      @default(now())
  updatedAt                                               DateTime      @updatedAt
  onboardingQuizCompletedAt                               DateTime?
  onboardingQuizPassed                                    Boolean       @default(false)
  onboardingQuizScore                                     Int           @default(0)
  gemCount                                                Int           @default(0)
  country                                                 String?
  stripeConnectedAt                                       DateTime?
  affiliateEarnings                                       Int           @default(0)
  expertBio                                               String?
  expertCredentials                                       String?
  expertVerifiedAt                                        DateTime?
  expertVerifiedBy                                        String?
  isIndustryExpert                                        Boolean       @default(false)
  Payout                                                  Payout[]
  Purchase_Purchase_referredByReviewerIdToReviewerProfile Purchase[]    @relation("Purchase_referredByReviewerIdToReviewerProfile")
  Purchase_Purchase_reviewerIdToReviewerProfile           Purchase[]    @relation("Purchase_reviewerIdToReviewerProfile")
  Review                                                  Review[]
  ReviewQueue                                             ReviewQueue[]
  User                                                    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  Genre                                                   Genre[]       @relation("ReviewerGenres")

  @@index([lastReviewDate])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model StripeWebhookEvent {
  id        String   @id @default(cuid())
  type      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([expiresAt])
}

model SupportMessage {
  id            String                   @id @default(cuid())
  ticketId      String
  authorType    SupportMessageAuthorType
  authorUserId  String?
  authorEmail   String?
  body          String
  createdAt     DateTime                 @default(now())
  SupportTicket SupportTicket            @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId, createdAt])
}

model SupportTicket {
  id             String              @id @default(cuid())
  userId         String
  subject        String
  status         SupportTicketStatus @default(OPEN)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  SupportMessage SupportMessage[]
  User           User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status, updatedAt])
  @@index([userId, createdAt])
}

model Track {
  id                         String               @id @default(cuid())
  artistId                   String
  sourceUrl                  String
  sourceType                 TrackSource
  title                      String
  artworkUrl                 String?
  duration                   Int?
  feedbackFocus              String?
  status                     TrackStatus          @default(PENDING_PAYMENT)
  packageType                PackageType
  reviewsRequested           Int
  reviewsCompleted           Int                  @default(0)
  createdAt                  DateTime             @default(now())
  paidAt                     DateTime?
  completedAt                DateTime?
  bpm                        Int?
  promoCode                  String?
  linkIssueNotifiedAt        DateTime?
  allowPurchase              Boolean              @default(false)
  isPublic                   Boolean              @default(false)
  hasStems                   Boolean              @default(false)
  abletonProjectUrl          String?
  abletonProjectData         Json?
  abletonRenderStatus        AbletonRenderStatus?
  lastViewedAt               DateTime?
  viewCount                  Int                  @default(0)
  publicPlayCount            Int                  @default(0)
  salePrice                  Int?
  sharingEnabled             Boolean              @default(false)
  sharingMode                SharingMode?
  showReviewsOnPublicPage    Boolean              @default(true)
  trackShareId               String?              @unique
  creditsSpent               Int                  @default(0)
  feedbackViewedAt           DateTime?
  abTestPrimaryTrackId       String?              @unique
  cashAddOnTotal             Int                  @default(0)
  isAbTest                   Boolean              @default(false)
  requestedExpertReviewers   Boolean              @default(false)
  requestedProReviewers      Boolean              @default(false)
  rushDelivery               Boolean              @default(false)
  rushDeliveryDeadline       DateTime?
  releaseDecisionGeneratedAt DateTime?
  releaseDecisionReport      Json?
  AddOnPayment               AddOnPayment[]
  ExternalPurchase           ExternalPurchase[]
  Payment                    Payment?
  Purchase                   Purchase[]
  Review                     Review[]
  ReviewQueue                ReviewQueue[]
  Track                      Track?               @relation("TrackToTrack", fields: [abTestPrimaryTrackId], references: [id])
  other_Track                Track?               @relation("TrackToTrack")
  ArtistProfile              ArtistProfile        @relation(fields: [artistId], references: [id], onDelete: Cascade)
  TrackAffiliateLink         TrackAffiliateLink[]
  TrackStem                  TrackStem[]
  Genre                      Genre[]              @relation("TrackGenres")
  ChartSubmission            ChartSubmission[]

  @@index([artistId])
  @@index([paidAt])
  @@index([status, createdAt])
  @@index([abletonRenderStatus])
}

model TrackAffiliateLink {
  id              String   @id @default(cuid())
  trackId         String
  code            String   @unique
  name            String
  createdByUserId String
  clickCount      Int      @default(0)
  playCount       Int      @default(0)
  purchaseCount   Int      @default(0)
  totalRevenue    Int      @default(0)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  User            User     @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)
  Track           Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([createdByUserId])
  @@index([trackId])
}

model User {
  id                     String                   @id @default(cuid())
  email                  String                   @unique
  password               String?
  name                   String?
  image                  String?
  emailVerified          DateTime?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  isArtist               Boolean                  @default(true)
  isReviewer             Boolean                  @default(true)
  referralSource         String?
  trialReminderSentAt    DateTime?
  lastActiveAt           DateTime?
  referralCode           String?                  @unique
  referralCouponId       String?
  referralRewardsEarned  Int                      @default(0)
  referredByCode         String?
  totalReferrals         Int                      @default(0)
  Account                Account[]
  ArtistProfile          ArtistProfile?
  EmailVerificationToken EmailVerificationToken[]
  ExternalPurchase       ExternalPurchase[]
  PasswordResetToken     PasswordResetToken[]
  ReviewerProfile        ReviewerProfile?
  Session                Session[]
  SupportTicket          SupportTicket[]
  TrackAffiliateLink     TrackAffiliateLink[]
  ChartVote              ChartVote[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model AddOnPayment {
  id                    String        @id @default(cuid())
  trackId               String
  addOnType             AddOnType
  amountCents           Int
  stripePaymentIntentId String?
  status                PaymentStatus @default(PENDING)
  createdAt             DateTime      @default(now())
  completedAt           DateTime?
  Track                 Track         @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@index([trackId])
  @@index([status])
}

model LeadCapture {
  id         String   @id
  email      String
  source     String   @default("get-feedback")
  reminded   Boolean  @default(false)
  converted  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  artistName String?

  @@index([email])
  @@index([reminded, createdAt])
}

model TrackStem {
  id           String   @id
  trackId      String
  stemUrl      String
  stemType     StemType
  label        String
  order        Int
  duration     Int?
  waveformData Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  Track        Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@index([trackId])
  @@index([trackId, order])
}

enum AddOnType {
  PRO_REVIEWERS
  EXPERT_REVIEWERS
  RUSH_DELIVERY
  AB_TEST
}

enum AddressedArtistNote {
  YES
  PARTIALLY
  NO
}

enum ExternalPurchaseStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum FirstImpression {
  STRONG_HOOK
  DECENT
  LOST_INTEREST
}

enum LowEndClarity {
  PERFECT
  KICK_TOO_LOUD
  BASS_TOO_LOUD
  BOTH_MUDDY
  BARELY_AUDIBLE
}

enum VocalClarity {
  CRYSTAL_CLEAR
  SLIGHTLY_BURIED
  BURIED
  TOO_LOUD
  NOT_APPLICABLE
}

enum HighEndQuality {
  PERFECT
  TOO_DULL
  TOO_HARSH
  ACCEPTABLE
}

enum StereoWidth {
  TOO_NARROW
  GOOD_BALANCE
  TOO_WIDE
}

enum DynamicsQuality {
  GREAT_DYNAMICS
  ACCEPTABLE
  TOO_COMPRESSED
  TOO_QUIET
}

enum EnergyCurve {
  BUILDS_PERFECTLY
  STAYS_FLAT
  BUILDS_NO_PAYOFF
  ALL_OVER_PLACE
}

enum TrackLength {
  TOO_SHORT
  PERFECT
  BIT_LONG
  WAY_TOO_LONG
}

enum PlaylistAction {
  ADD_TO_LIBRARY
  LET_PLAY
  SKIP
  DISLIKE
}

enum NextFocus {
  MIXING
  ARRANGEMENT
  SOUND_DESIGN
  SONGWRITING
  PERFORMANCE
  READY_TO_RELEASE
}

enum ExpectedPlacement {
  EDITORIAL
  SOUNDCLOUD_TRENDING
  CLUB
  COFFEE_SHOP
  VIDEO_GAME
  AD
  NOWHERE
}

enum QualityLevel {
  NOT_READY
  DEMO_STAGE
  ALMOST_THERE
  RELEASE_READY
  PROFESSIONAL
}

enum ReviewerExpertise {
  PRO_PRODUCER
  INTERMEDIATE
  BEGINNER
  LISTENER_ONLY
}

enum PackageType {
  STARTER
  STANDARD
  PRO
  DEEP_DIVE
  PEER
  RELEASE_DECISION
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PayoutMethod {
  PAYPAL
  STRIPE_CONNECT
  MANUAL
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ReviewStatus {
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  EXPIRED
  SKIPPED
}

enum ReviewerTier {
  NORMAL
  PRO
}

enum SharingMode {
  EXPOSURE
  SALES
}

enum SupportMessageAuthorType {
  USER
  ADMIN
}

enum SupportTicketStatus {
  OPEN
  NEEDS_INFO
  RESOLVED
  CLOSED
}

enum TrackSource {
  SOUNDCLOUD
  BANDCAMP
  YOUTUBE
  SPOTIFY
  UPLOAD
}

enum TrackStatus {
  PENDING_PAYMENT
  QUEUED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  UPLOADED
}

enum ReleaseVerdict {
  RELEASE_NOW
  FIX_FIRST
  NEEDS_WORK
}

enum FixImpact {
  HIGH
  MEDIUM
  LOW
}

enum ABTestPreference {
  VERSION_A
  VERSION_B
  NO_PREFERENCE
}

enum AbletonRenderStatus {
  PENDING
  RENDERING
  COMPLETED
  FAILED
}

enum StemType {
  MASTER
  DRUMS
  BASS
  SYNTHS
  VOCALS
  MELODY
  FX
  OTHER
}

// ── Daily Chart ─────────────────────────────────────────────────
model ChartSubmission {
  id            String        @id @default(cuid())
  trackId       String
  artistId      String
  chartDate     DateTime      @db.Date
  title         String
  artworkUrl    String?
  sourceUrl     String
  sourceType    TrackSource
  genre         String?
  voteCount     Int           @default(0)
  playCount     Int           @default(0)
  rank          Int?
  isFeatured    Boolean       @default(false)
  createdAt     DateTime      @default(now())

  Track         Track         @relation(fields: [trackId], references: [id], onDelete: Cascade)
  ArtistProfile ArtistProfile @relation(fields: [artistId], references: [id], onDelete: Cascade)
  ChartVote     ChartVote[]

  @@unique([trackId, chartDate])
  @@unique([artistId, chartDate])
  @@index([chartDate, voteCount])
  @@index([chartDate, rank])
  @@index([isFeatured])
}

model ChartVote {
  id              String          @id @default(cuid())
  submissionId    String
  voterId         String
  listenDuration  Int             @default(0)
  createdAt       DateTime        @default(now())

  ChartSubmission ChartSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  User            User            @relation(fields: [voterId], references: [id], onDelete: Cascade)

  @@unique([submissionId, voterId])
  @@index([voterId, createdAt])
}
