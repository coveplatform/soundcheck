generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Account {
  id                String @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model ArtistProfile {
  id                           String @id @default(cuid())
  userId                       String        @unique
  artistName                   String
  totalTracks                  Int           @default(0)
  totalSpent                   Int           @default(0)
  createdAt                    DateTime      @default(now())
  updatedAt                    DateTime @updatedAt
  pendingBalance               Int           @default(0)
  stripeAccountId              String?       @unique
  stripeConnectedAt            DateTime?
  totalEarnings                Int           @default(0)
  stripeCustomerId             String?
  subscriptionId               String?
  subscriptionStatus           String?
  subscriptionTier             String?
  completedOnboarding          Boolean       @default(false)
  hasSeenCreditGuide           Boolean       @default(false)
  hasSeenWelcome               Boolean       @default(false)
  peerFlagCount                Int           @default(0)
  peerGemCount                 Int           @default(0)
  peerReviewRating             Float         @default(0)
  reviewCredits                Int           @default(1)
  totalCreditsEarned           Int           @default(0)
  totalCreditsSpent            Int           @default(0)
  totalPeerReviews             Int           @default(0)
  reviewerExpertise            ReviewerExpertise?
  User                         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  Review                       Review[]
  ReviewQueue                  ReviewQueue[]
  Track                        Track[]
  Genre_ArtistGenres           Genre[]       @relation("ArtistGenres")
  Genre_ArtistReviewGenres     Genre[]       @relation("ArtistReviewGenres")
}

model EmailVerificationToken {
  id        String @id @default(cuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model ExternalPurchase {
  id                      String @id @default(cuid())
  trackId                 String
  buyerEmail              String
  buyerName               String?
  amount                  Int
  stripePaymentIntentId   String                 @unique
  stripeCheckoutSessionId String?
  status                  ExternalPurchaseStatus @default(PENDING)
  platformFee             Int
  affiliateCommission     Int                    @default(0)
  artistAmount            Int
  affiliateCode           String?
  affiliateUserId         String?
  downloadUrl             String?
  downloadedAt            DateTime?
  downloadCount           Int                    @default(0)
  createdAt               DateTime               @default(now())
  completedAt             DateTime?
  User                    User?                  @relation(fields: [affiliateUserId], references: [id])
  Track                   Track                  @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@index([affiliateCode])
  @@index([affiliateUserId])
  @@index([buyerEmail])
  @@index([status])
  @@index([trackId])
}

model Genre {
  id                               String @id @default(cuid())
  name                             String            @unique
  slug                             String            @unique
  ArtistProfile_ArtistGenres       ArtistProfile[]   @relation("ArtistGenres")
  ArtistProfile_ArtistReviewGenres ArtistProfile[]   @relation("ArtistReviewGenres")
  ReviewerProfile                  ReviewerProfile[] @relation("ReviewerGenres")
  Track                            Track[]           @relation("TrackGenres")
}

model PasswordResetToken {
  id        String @id @default(cuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model Payment {
  id              String @id @default(cuid())
  trackId         String        @unique
  amount          Int
  stripeSessionId String        @unique
  stripePaymentId String?
  status          PaymentStatus @default(PENDING)
  createdAt       DateTime      @default(now())
  completedAt     DateTime?
  Track           Track         @relation(fields: [trackId], references: [id], onDelete: Cascade)
}

model Payout {
  id              String @id @default(cuid())
  reviewerId      String
  amount          Int
  method          PayoutMethod
  status          PayoutStatus
  externalId      String?
  createdAt       DateTime        @default(now())
  processedAt     DateTime?
  ReviewerProfile ReviewerProfile @relation(fields: [reviewerId], references: [id])
}

model Purchase {
  id                                                             String @id @default(cuid())
  trackId                                                        String
  reviewerId                                                     String
  amount                                                         Int
  createdAt                                                      DateTime         @default(now())
  referredByReviewerId                                           String?
  referralShareId                                                String?
  commissionPaid                                                 Int              @default(0)
  ReviewerProfile_Purchase_referredByReviewerIdToReviewerProfile ReviewerProfile? @relation("Purchase_referredByReviewerIdToReviewerProfile", fields: [referredByReviewerId], references: [id])
  ReviewerProfile_Purchase_reviewerIdToReviewerProfile           ReviewerProfile  @relation("Purchase_reviewerIdToReviewerProfile", fields: [reviewerId], references: [id], onDelete: Cascade)
  Track                                                          Track            @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@unique([trackId, reviewerId])
  @@index([referredByReviewerId])
  @@index([reviewerId])
  @@index([trackId])
}

model RateLimit {
  id        String @id @default(cuid())
  count     Int      @default(0)
  resetAt   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resetAt])
}

model Review {
  id                     String @id @default(cuid())
  trackId                String
  reviewerId             String?
  status                 ReviewStatus         @default(ASSIGNED)
  listenDuration         Int                  @default(0)
  lastHeartbeat          DateTime?
  firstImpression        FirstImpression?
  productionScore        Int?
  vocalScore             Int?
  originalityScore       Int?
  wouldListenAgain       Boolean?
  perceivedGenre         String?
  similarArtists         String?
  bestPart               String?
  bestPartTimestamp      Int?
  weakestPart            String?
  weakestTimestamp       Int?
  additionalNotes        String?
  paidAmount             Int                  @default(0)
  artistRating           Int?
  wasFlagged             Boolean              @default(false)
  flagReason             String?
  createdAt              DateTime             @default(now())
  updatedAt              DateTime @updatedAt
  isGem                  Boolean              @default(false)
  addressedArtistNote    AddressedArtistNote?
  nextActions            String?
  timestamps             Json?
  wouldAddToPlaylist     Boolean?
  wouldFollow            Boolean?
  wouldShare             Boolean?
  shareId                String?              @unique
  countsTowardAnalytics  Boolean              @default(true)
  countsTowardCompletion Boolean              @default(true)
  reviewSchemaVersion    Int                  @default(1)
  isPeerReview           Boolean              @default(false)
  peerReviewerArtistId   String?
  // Enhanced feedback fields (v2)
  lowEndClarity          LowEndClarity?
  vocalClarity           VocalClarity?
  highEndQuality         HighEndQuality?
  stereoWidth            StereoWidth?
  dynamics               DynamicsQuality?
  energyCurve            EnergyCurve?
  tooRepetitive          Boolean?
  repetitiveNote         String?
  lostInterestAt         Int?
  lostInterestReason     String?
  trackLength            TrackLength?
  emotionalImpact        Json?
  memorableMoment        String?
  playlistAction         PlaylistAction?
  biggestWeaknessSpecific String?
  quickWin               String?
  targetAudience         Json?
  nextFocus              NextFocus?
  expectedPlacement      ExpectedPlacement?
  qualityLevel           QualityLevel?
  reviewerExpertise      ReviewerExpertise?

  // Release Decision fields (v3)
  releaseVerdict         ReleaseVerdict?      // Overall verdict
  releaseReadinessScore  Int?                 // 0-100 score
  topFixRank1            String?              // #1 priority fix
  topFixRank1Impact      FixImpact?           // Impact level
  topFixRank1TimeMin     Int?                 // Estimated minutes
  topFixRank2            String?              // #2 priority fix
  topFixRank2Impact      FixImpact?
  topFixRank2TimeMin     Int?
  topFixRank3            String?              // #3 priority fix
  topFixRank3Impact      FixImpact?
  topFixRank3TimeMin     Int?
  strongestElement       String?              // What's working best
  biggestRisk            String?              // Main release concern
  competitiveBenchmark   String?              // Where it stands vs competition

  ArtistProfile          ArtistProfile?       @relation(fields: [peerReviewerArtistId], references: [id])
  ReviewerProfile        ReviewerProfile?     @relation(fields: [reviewerId], references: [id], onDelete: Cascade)
  Track                  Track                @relation(fields: [trackId], references: [id], onDelete: Cascade)
  ReviewTimestamp        ReviewTimestamp[]

  @@unique([trackId, reviewerId])
  @@unique([trackId, peerReviewerArtistId])
  @@index([reviewerId, status])
  @@index([status])
  @@index([trackId])
}

model ReviewQueue {
  id               String @id @default(cuid())
  trackId          String
  reviewerId       String?
  priority         Int             @default(0)
  assignedAt       DateTime        @default(now())
  expiresAt        DateTime
  artistReviewerId String?
  ArtistProfile    ArtistProfile?  @relation(fields: [artistReviewerId], references: [id], onDelete: Cascade)
  ReviewerProfile  ReviewerProfile? @relation(fields: [reviewerId], references: [id], onDelete: Cascade)
  Track            Track           @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@unique([trackId, reviewerId])
  @@unique([trackId, artistReviewerId])
  @@index([artistReviewerId])
  @@index([reviewerId, expiresAt])
}

model ReviewTimestamp {
  id        String @id @default(cuid())
  reviewId  String
  seconds   Int
  note      String
  createdAt DateTime @default(now())
  Review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@index([reviewId, seconds])
}

model ReviewerProfile {
  id                                                      String @id @default(cuid())
  userId                                                  String        @unique
  tier                                                    ReviewerTier  @default(NORMAL)
  totalReviews                                            Int           @default(0)
  averageRating                                           Float         @default(0)
  totalEarnings                                           Int           @default(0)
  pendingBalance                                          Int           @default(0)
  stripeAccountId                                         String?       @unique
  flagCount                                               Int           @default(0)
  isRestricted                                            Boolean       @default(false)
  completedOnboarding                                     Boolean       @default(false)
  reviewsToday                                            Int           @default(0)
  lastReviewDate                                          DateTime?
  createdAt                                               DateTime      @default(now())
  updatedAt                                               DateTime @updatedAt
  onboardingQuizCompletedAt                               DateTime?
  onboardingQuizPassed                                    Boolean       @default(false)
  onboardingQuizScore                                     Int           @default(0)
  gemCount                                                Int           @default(0)
  country                                                 String?
  stripeConnectedAt                                       DateTime?
  affiliateEarnings                                       Int           @default(0)
  Payout                                                  Payout[]
  Purchase_Purchase_referredByReviewerIdToReviewerProfile Purchase[]    @relation("Purchase_referredByReviewerIdToReviewerProfile")
  Purchase_Purchase_reviewerIdToReviewerProfile           Purchase[]    @relation("Purchase_reviewerIdToReviewerProfile")
  Review                                                  Review[]
  ReviewQueue                                             ReviewQueue[]
  User                                                    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  Genre                                                   Genre[]       @relation("ReviewerGenres")

  @@index([lastReviewDate])
}

model Session {
  id           String @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model StripeWebhookEvent {
  id        String @id @default(cuid())
  type      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([expiresAt])
}

model SupportMessage {
  id            String @id @default(cuid())
  ticketId      String
  authorType    SupportMessageAuthorType
  authorUserId  String?
  authorEmail   String?
  body          String
  createdAt     DateTime                 @default(now())
  SupportTicket SupportTicket            @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId, createdAt])
}

model SupportTicket {
  id             String @id @default(cuid())
  userId         String
  subject        String
  status         SupportTicketStatus @default(OPEN)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime @updatedAt
  SupportMessage SupportMessage[]
  User           User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status, updatedAt])
  @@index([userId, createdAt])
}

model Track {
  id                      String @id @default(cuid())
  artistId                String
  sourceUrl               String
  sourceType              TrackSource
  title                   String
  artworkUrl              String?
  duration                Int?
  feedbackFocus           String?
  status                  TrackStatus          @default(PENDING_PAYMENT)
  packageType             PackageType
  reviewsRequested        Int
  reviewsCompleted        Int                  @default(0)
  createdAt               DateTime             @default(now())
  paidAt                  DateTime?
  completedAt             DateTime?
  bpm                     Int?
  promoCode               String?
  linkIssueNotifiedAt     DateTime?
  allowPurchase           Boolean              @default(false)
  isPublic                Boolean              @default(false)
  feedbackViewedAt        DateTime?
  lastViewedAt            DateTime?
  viewCount               Int                  @default(0)
  publicPlayCount         Int                  @default(0)
  salePrice               Int?
  sharingEnabled          Boolean              @default(false)
  sharingMode             SharingMode?
  showReviewsOnPublicPage Boolean              @default(true)
  trackShareId            String?              @unique
  creditsSpent            Int                  @default(0)
  requestedProReviewers   Boolean              @default(false)
  rushDelivery            Boolean              @default(false)
  rushDeliveryDeadline    DateTime?
  cashAddOnTotal          Int                  @default(0)
  releaseDecisionReport   Json?                // Compiled Release Decision report
  releaseDecisionGeneratedAt DateTime?         // When report was generated
  ExternalPurchase        ExternalPurchase[]
  Payment                 Payment?
  Purchase                Purchase[]
  Review                  Review[]
  ReviewQueue             ReviewQueue[]
  ArtistProfile           ArtistProfile        @relation(fields: [artistId], references: [id], onDelete: Cascade)
  TrackAffiliateLink      TrackAffiliateLink[]
  Genre                   Genre[]              @relation("TrackGenres")
  AddOnPayment            AddOnPayment[]

  @@index([artistId])
  @@index([paidAt])
  @@index([status, createdAt])
}

model TrackAffiliateLink {
  id              String @id @default(cuid())
  trackId         String
  code            String   @unique
  name            String
  createdByUserId String
  clickCount      Int      @default(0)
  playCount       Int      @default(0)
  purchaseCount   Int      @default(0)
  totalRevenue    Int      @default(0)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  User            User     @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)
  Track           Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([createdByUserId])
  @@index([trackId])
}

model User {
  id                     String @id @default(cuid())
  email                  String                   @unique
  password               String?
  name                   String?
  image                  String?
  emailVerified          DateTime?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime @updatedAt
  lastActiveAt           DateTime?
  isArtist               Boolean                  @default(true)
  isReviewer             Boolean                  @default(true)
  referralSource         String?
  trialReminderSentAt    DateTime?
  referralCode           String?                  @unique
  referredByCode         String?
  referralCouponId       String?
  totalReferrals         Int                      @default(0)
  referralRewardsEarned  Int                      @default(0)
  Account                Account[]
  ArtistProfile          ArtistProfile?
  EmailVerificationToken EmailVerificationToken[]
  ExternalPurchase       ExternalPurchase[]
  PasswordResetToken     PasswordResetToken[]
  ReviewerProfile        ReviewerProfile?
  Session                Session[]
  SupportTicket          SupportTicket[]
  TrackAffiliateLink     TrackAffiliateLink[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model AddOnPayment {
  id                    String        @id @default(cuid())
  trackId               String
  addOnType             AddOnType
  amountCents           Int
  stripePaymentIntentId String?
  status                PaymentStatus @default(PENDING)
  createdAt             DateTime      @default(now())
  completedAt           DateTime?
  Track                 Track         @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@index([trackId])
  @@index([status])
}

enum AddOnType {
  PRO_REVIEWERS
  EXPERT_REVIEWERS
  RUSH_DELIVERY
}

enum AddressedArtistNote {
  YES
  PARTIALLY
  NO
}

enum ExternalPurchaseStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum FirstImpression {
  STRONG_HOOK
  DECENT
  LOST_INTEREST
}

enum LowEndClarity {
  PERFECT
  KICK_TOO_LOUD
  BASS_TOO_LOUD
  BOTH_MUDDY
  BARELY_AUDIBLE
}

enum VocalClarity {
  CRYSTAL_CLEAR
  SLIGHTLY_BURIED
  BURIED
  TOO_LOUD
  NOT_APPLICABLE
}

enum HighEndQuality {
  PERFECT
  TOO_DULL
  TOO_HARSH
  ACCEPTABLE
}

enum StereoWidth {
  TOO_NARROW
  GOOD_BALANCE
  TOO_WIDE
}

enum DynamicsQuality {
  GREAT_DYNAMICS
  ACCEPTABLE
  TOO_COMPRESSED
  TOO_QUIET
}

enum EnergyCurve {
  BUILDS_PERFECTLY
  STAYS_FLAT
  BUILDS_NO_PAYOFF
  ALL_OVER_PLACE
}

enum TrackLength {
  TOO_SHORT
  PERFECT
  BIT_LONG
  WAY_TOO_LONG
}

enum PlaylistAction {
  ADD_TO_LIBRARY
  LET_PLAY
  SKIP
  DISLIKE
}

enum NextFocus {
  MIXING
  ARRANGEMENT
  SOUND_DESIGN
  SONGWRITING
  PERFORMANCE
  READY_TO_RELEASE
}

enum ExpectedPlacement {
  EDITORIAL
  SOUNDCLOUD_TRENDING
  CLUB
  COFFEE_SHOP
  VIDEO_GAME
  AD
  NOWHERE
}

enum QualityLevel {
  NOT_READY
  DEMO_STAGE
  ALMOST_THERE
  RELEASE_READY
  PROFESSIONAL
}

enum ReviewerExpertise {
  PRO_PRODUCER
  INTERMEDIATE
  BEGINNER
  LISTENER_ONLY
}

enum PackageType {
  STARTER         // DEPRECATED - kept for existing data only
  STANDARD        // DEPRECATED - kept for existing data only
  PRO             // DEPRECATED - kept for existing data only
  DEEP_DIVE       // DEPRECATED - kept for existing data only
  PEER            // Active: Credit-based community reviews
  RELEASE_DECISION // Active: Premium expert review service
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PayoutMethod {
  PAYPAL
  STRIPE_CONNECT
  MANUAL
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ReviewStatus {
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  EXPIRED
  SKIPPED
}

enum ReviewerTier {
  NORMAL
  PRO
}

enum SharingMode {
  EXPOSURE
  SALES
}

enum SupportMessageAuthorType {
  USER
  ADMIN
}

enum SupportTicketStatus {
  OPEN
  NEEDS_INFO
  RESOLVED
  CLOSED
}

enum TrackSource {
  SOUNDCLOUD
  BANDCAMP
  YOUTUBE
  UPLOAD
}

enum TrackStatus {
  PENDING_PAYMENT
  QUEUED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  UPLOADED
}

enum ReleaseVerdict {
  RELEASE_NOW    // Track is ready to release
  FIX_FIRST      // Close, but needs specific fixes
  NEEDS_WORK     // Not ready, requires significant work
}

enum FixImpact {
  HIGH           // Critical issue affecting listenability
  MEDIUM         // Noticeable but not fatal
  LOW            // Nice to have improvement
}
